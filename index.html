<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>明学智答</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', "PingFang SC", "Microsoft YaHei", Roboto, Helvetica, Arial, sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        /* Markdown Styles within chat */
        .prose { max-width: none; line-height: 1.7; }
        .prose h1, .prose h2, .prose h3 { margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; color: #1e293b; }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose p { margin-bottom: 0.8em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 0.8em; }
        .prose code { background-color: #f1f5f9; padding: 0.2em 0.4em; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, monospace; font-size: 0.92em; color: #0f172a; }
        .prose pre { background-color: #1e293b; color: #e2e8f0; padding: 1em; border-radius: 10px; overflow-x: auto; margin-bottom: 1em; }
        .prose pre code { background-color: transparent; color: inherit; padding: 0; }
        .prose blockquote { border-left: 4px solid #cbd5e1; padding-left: 1em; color: #64748b; font-style: italic; }
        /* Animation for loading dots */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        /* Hover Effects */
        .card-hover { transition: all .2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        /* Logo Animation */
        .logo-glow { filter: drop-shadow(0 10px 15px rgba(59, 130, 246, 0.2)); }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 selection:bg-blue-100 selection:text-blue-900">
    <!-- App Shell -->
    <div class="min-h-screen flex flex-col">
        <!-- Top Bar -->
        <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200/80">
            <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
                <button id="btn-home" class="flex items-center gap-3 group" title="回到首页">
                    <!-- Logo: Small -->
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center shadow-sm bg-white border border-slate-100">
                        <svg width="28" height="28" viewBox="0 0 112 112" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="g-book-small" x1="20" y1="20" x2="92" y2="92" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#1e293b"/>
                                    <stop offset="1" stop-color="#334155"/>
                                </linearGradient>
                                <linearGradient id="g-page-small" x1="20" y1="20" x2="92" y2="92" gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#FFFFFF"/>
                                    <stop offset="1" stop-color="#E2E8F0"/>
                                </linearGradient>
                            </defs>
                            <rect x="16" y="20" width="80" height="72" rx="6" fill="url(#g-book-small)"/>
                            <path d="M56 26V86" stroke="#475569" stroke-width="2"/>
                            <path d="M56 86C56 86 46 92 24 88V28C46 32 56 26 56 26Z" fill="url(#g-page-small)"/>
                            <path d="M56 86C56 86 66 92 88 88V28C66 32 56 26 56 26Z" fill="url(#g-page-small)"/>
                            <path d="M56 10L60 20H68L62 26L64 34L56 30L48 34L50 26L44 20H52L56 10Z" fill="#F59E0B"/>
                        </svg>
                    </div>
                    <div class="leading-tight text-left">
                        <div class="font-serif font-bold text-lg tracking-wide text-slate-800">明学智答</div>
                    </div>
                </button>
                <div class="flex items-center gap-2">
                    <button id="btn-open-chat" class="hidden sm:inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 text-white hover:bg-slate-700 shadow-sm transition-colors">
                        <i class="fa-solid fa-comment-dots"></i>
                        <span class="text-sm font-medium">自由提问</span>
                    </button>
                </div>
            </div>
        </header>
        <!-- Views -->
        <main class="flex-1">
            <!-- HOME VIEW -->
            <section id="view-home" class="block">
                <div class="max-w-5xl mx-auto px-4 md:px-6 py-12 md:py-20">
                    <div class="flex flex-col items-center text-center">
                        <!-- Logo: Large -->
                        <div class="logo-glow mb-6 relative">
                            <svg width="120" height="120" viewBox="0 0 112 112" fill="none" xmlns="http://www.w3.org/2000/svg" class="select-none">
                                <defs>
                                    <linearGradient id="g-book" x1="10" y1="10" x2="100" y2="100" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#1e293b"/>
                                        <stop offset="1" stop-color="#334155"/>
                                    </linearGradient>
                                    <linearGradient id="g-page" x1="20" y1="20" x2="92" y2="92" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#FFFFFF"/>
                                        <stop offset="1" stop-color="#F1F5F9"/>
                                    </linearGradient>
                                    <filter id="shadow" x="-10" y="-10" width="132" height="132" filterUnits="userSpaceOnUse">
                                        <feDropShadow dx="0" dy="8" stdDeviation="6" flood-color="rgba(0,0,0,0.15)"/>
                                    </filter>
                                </defs>
                                <!-- Book Cover -->
                                <rect x="14" y="18" width="84" height="76" rx="8" fill="url(#g-book)" filter="url(#shadow)"/>
                                <!-- Spine Line -->
                                <path d="M56 24V88" stroke="#475569" stroke-width="1"/>
                                <!-- Left Page -->
                                <path d="M56 88C56 88 44 94 20 90V26C44 30 56 24 56 24Z" fill="url(#g-page)"/>
                                <!-- Right Page -->
                                <path d="M56 88C56 88 68 94 92 90V26C68 30 56 24 56 24Z" fill="url(#g-page)"/>
                                <!-- Text Lines Left -->
                                <path d="M28 40H48" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <path d="M28 50H48" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <path d="M28 60H44" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <!-- Text Lines Right -->
                                <path d="M64 40H84" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <path d="M64 50H84" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <path d="M64 60H80" stroke="#CBD5E1" stroke-width="2" stroke-linecap="round"/>
                                <!-- Golden Star/Spark -->
                                <path d="M56 8L61 22H74L64 30L68 42L56 34L44 42L48 30L38 22H51L56 8Z" fill="#F59E0B" stroke="white" stroke-width="2"/>
                            </svg>
                        </div>
                        <h1 class="text-4xl md:text-5xl font-serif font-bold tracking-tight text-slate-900">明学智答</h1>
                        <p class="mt-4 text-lg text-slate-600 max-w-2xl leading-relaxed">
                            您的全科智能教学助手。请选择学习阶段，获取结构化的知识图谱与AI辅导。
                        </p>
                    </div>
                    <!-- Modules -->
                    <div id="modules" class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Primary: Amber Theme -->
                        <button data-module="primary" class="card-hover relative overflow-hidden group text-left bg-amber-50 border border-amber-200 rounded-2xl p-6 hover:border-amber-300 hover:shadow-amber-100/50 shadow-sm">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-amber-100 rounded-full opacity-50 blur-2xl group-hover:scale-110 transition-transform"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-white text-amber-600 flex items-center justify-center shadow-sm mb-4 text-xl border border-amber-100">
                                    <i class="fa-solid fa-seedling"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-amber-900">小学</h3>
                                <div class="text-sm font-semibold text-amber-700/80 mb-2 uppercase tracking-wider">启蒙与基础</div>
                                <p class="text-amber-800/70 text-sm leading-relaxed">
                                    语数英启蒙、科学探究与习惯养成。<br>注重兴趣引导与基础概念构建。
                                </p>
                            </div>
                        </button>
                        <!-- Secondary: Sky Theme -->
                        <button data-module="secondary" class="card-hover relative overflow-hidden group text-left bg-sky-50 border border-sky-200 rounded-2xl p-6 hover:border-sky-300 hover:shadow-sky-100/50 shadow-sm">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-sky-100 rounded-full opacity-50 blur-2xl group-hover:scale-110 transition-transform"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-white text-sky-600 flex items-center justify-center shadow-sm mb-4 text-xl border border-sky-100">
                                    <i class="fa-solid fa-layer-group"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-sky-900">中学</h3>
                                <div class="text-sm font-semibold text-sky-700/80 mb-2 uppercase tracking-wider">体系与应试</div>
                                <p class="text-sky-800/70 text-sm leading-relaxed">
                                    初高中全科体系、应试策略与模型思维。<br>注重逻辑推演与解题方法。
                                </p>
                            </div>
                        </button>
                        <!-- University: Indigo Theme -->
                        <button data-module="university" class="card-hover relative overflow-hidden group text-left bg-indigo-50 border border-indigo-200 rounded-2xl p-6 hover:border-indigo-300 hover:shadow-indigo-100/50 shadow-sm">
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-indigo-100 rounded-full opacity-50 blur-2xl group-hover:scale-110 transition-transform"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-white text-indigo-600 flex items-center justify-center shadow-sm mb-4 text-xl border border-indigo-100">
                                    <i class="fa-solid fa-graduation-cap"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-indigo-900">大学</h3>
                                <div class="text-sm font-semibold text-indigo-700/80 mb-2 uppercase tracking-wider">专业与深造</div>
                                <p class="text-indigo-800/70 text-sm leading-relaxed">
                                    十二大学科门类、专业课程与科研实践。<br>注重理论深度与工程应用。
                                </p>
                            </div>
                        </button>
                    </div>
                </div>
            </section>
            <!-- CATALOG VIEW -->
            <section id="view-catalog" class="hidden min-h-[80vh] bg-slate-50/50">
                <div class="max-w-6xl mx-auto px-4 md:px-6 py-8 md:py-12">
                    
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-8">
                        <div>
                            <button id="btn-back-home-text" class="text-sm font-medium text-slate-400 hover:text-slate-600 mb-2 flex items-center gap-1">
                                <i class="fa-solid fa-arrow-left"></i> 返回首页
                            </button>
                            <h2 id="catalog-title" class="text-3xl md:text-4xl font-bold text-slate-900"></h2>
                            <p id="catalog-subtitle" class="mt-2 text-slate-600 max-w-2xl"></p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="btn-catalog-open-chat" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl text-white shadow-md transition-transform active:scale-95 font-medium">
                                <i class="fa-solid fa-comment-dots"></i>
                                <span>就此提问</span>
                            </button>
                        </div>
                    </div>
                    <!-- Grid Content -->
                    <div id="catalog-content" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>
            </section>
            <!-- CHAT VIEW -->
            <section id="view-chat" class="hidden bg-white">
                <div class="max-w-5xl mx-auto h-[calc(100vh-65px)] flex flex-col">
                    
                    <!-- Chat Header -->
                    <div class="flex-none px-4 md:px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white z-10">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-robot text-blue-600"></i> 智能问答
                            </h2>
                            <p class="text-xs text-slate-500">AI生成内容仅供参考，请结合教材学习</p>
                        </div>
                        <button id="btn-chat-back" class="text-slate-400 hover:text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-50 transition-colors">
                            <i class="fa-solid fa-xmark text-lg"></i>
                        </button>
                    </div>
                    <!-- Messages Area -->
                    <main id="chat-container" class="flex-1 overflow-y-auto px-4 md:px-6 py-6 scroll-smooth bg-slate-50/30">
                        <div class="max-w-3xl mx-auto flex flex-col gap-8 pb-10">
                            <!-- Welcome Message -->
                            <div class="flex gap-4">
                                <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 text-blue-600 shadow-sm">
                                    <i class="fa-solid fa-robot"></i>
                                </div>
                                <div class="bg-white p-5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 prose prose-slate prose-sm">
                                    <p class="font-medium text-slate-800">你好！我是明学智答。</p>
                                    <p class="text-slate-600">
                                        你可以点击目录中的关键词提问，或者直接在这里输入问题。我会根据你选择的学习阶段（小学/中学/大学）来调整讲解方式。
                                    </p>
                                </div>
                            </div>
                            <div id="messages-list" class="flex flex-col gap-6"></div>
                            <!-- Loading -->
                            <div id="loading-indicator" class="hidden flex gap-4">
                                <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 text-blue-600 shadow-sm">
                                    <i class="fa-solid fa-robot"></i>
                                </div>
                                <div class="bg-white px-5 py-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 flex items-center gap-1">
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    </main>
                    <!-- Input Area -->
                    <div class="flex-none bg-white border-t border-slate-100 p-4 md:p-6">
                        <div class="max-w-3xl mx-auto relative">
                            <textarea id="user-input" rows="1"
                                class="w-full pl-5 pr-14 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none resize-none text-slate-700 shadow-inner transition-all max-h-40 min-h-[60px] text-base"
                                placeholder="输入问题... (Shift+Enter 换行)"></textarea>
                            <button id="send-btn" class="absolute right-3 bottom-3 w-10 h-10 bg-blue-600 hover:bg-blue-700 text-white rounded-xl flex items-center justify-center transition-colors shadow-md disabled:bg-slate-300 disabled:cursor-not-allowed disabled:shadow-none">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="py-8 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-200/50">
            © <span id="year"></span> 明学智答 · 分阶段智能教学系统
        </footer>
    </div>
    <script>
        /**
         * ====================================================================
         * 配置区域
         * ====================================================================
         */
        const API_CONFIG = {
            baseUrl: "https://api.silra.cn/v1",
            apiKey: "sk-OljKnEFkW0zElxmrMPyHOzqMqZHl68UiCjHbHa5mfIxoU9Nd",
            model: "deepseek-chat"
        };
        // ---------------------------
        // Data
        // ---------------------------
        const CATALOG = {
            primary: {
                title: "小学",
                subtitle: "以兴趣启蒙与基础能力为核心：阅读表达、计算能力与科学探究。",
                theme: "amber", // Color Theme
                sections: [
                    { name: "语文", desc: "阅读理解、写作表达、古诗文与基础语法。", keywords: ["拼音/汉字", "词语辨析", "句子成分", "修辞手法", "阅读理解：主旨/细节", "作文：结构/立意"] },
                    { name: "数学", desc: "数与运算、图形与几何、应用题思维。", keywords: ["四则运算", "分数/小数", "应用题：方程思想", "几何：周长/面积", "统计与概率入门", "速算与检验"] },
                    { name: "英语", desc: "自然拼读、基础语法、日常表达。", keywords: ["自然拼读", "时态入门", "句型：There be", "阅读：关键词定位", "写作：句型积累", "词汇：主题词"] },
                    { name: "科学", desc: "观察实验、物质与能量、生命与地球。", keywords: ["科学方法：观察/假设", "电路：串并联", "力与运动", "植物结构", "天气与水循环", "地球与太阳"] },
                    { name: "道德与法治", desc: "规则意识、公民素养与社会实践。", keywords: ["规则与责任", "安全教育", "尊重与合作", "诚信", "法律常识入门"] }
                ]
            },
            secondary: {
                title: "中学",
                subtitle: "以学科体系与能力提升为核心：概念—方法—模型—题型。",
                theme: "sky", // Color Theme
                sections: [
                    { name: "语文", desc: "现代文阅读、古诗文、作文与语言运用。", keywords: ["论述类文本", "文言文：实词/虚词", "古诗鉴赏", "作文：审题立意", "病句修改", "修辞与表达"] },
                    { name: "数学", desc: "代数、几何、函数、概率统计与数学建模。", keywords: ["函数与图像", "数列", "立体几何", "解析几何", "导数（高中）", "概率统计"] },
                    { name: "英语", desc: "语法体系、阅读/完形/写作与听说能力。", keywords: ["定语从句", "非谓语动词", "完形填空策略", "阅读：主旨/推断", "写作：高分句型", "词汇：派生"] },
                    { name: "物理", desc: "力学—电磁—热学—光学，强化模型与实验。", keywords: ["牛顿定律", "动能定理", "电场/磁场", "电路分析", "实验：误差分析", "波与光"] },
                    { name: "化学", desc: "物质结构、反应原理、化学计算与实验。", keywords: ["元素周期律", "化学键", "氧化还原", "平衡/速率", "离子反应", "滴定与实验设计"] },
                    { name: "生物", desc: "细胞—遗传—进化—生态，重过程与图表。", keywords: ["细胞结构与代谢", "光合作用", "遗传定律", "基因表达", "生态系统", "实验：对照与变量"] },
                    { name: "历史", desc: "时序框架+史料实证+因果分析。", keywords: ["中国古代制度", "近代化探索", "世界史：工业革命", "一战二战", "史料解读", "论述题结构"] },
                    { name: "地理", desc: "自然地理+人文地理+区域综合。", keywords: ["大气环流", "水循环", "板块构造", "人口与城市", "产业区位", "地理信息判读"] },
                    { name: "政治", desc: "概念体系+材料分析+时政结合。", keywords: ["经济：供需与宏观", "政治：国家机构", "哲学：矛盾分析", "文化与价值", "材料题套路"] }
                ]
            },
            university: {
                title: "大学",
                subtitle: "以专业能力与工程/科研训练为核心：十二大学科门类。",
                theme: "indigo", // Color Theme
                sections: [
                    { name: "工学", desc: "工程技术与系统设计", courses: [{ name: "工程力学", points: ["静力学", "材料力学"] }, { name: "机械设计", points: ["齿轮传动", "轴承寿命"] }, { name: "计算机", points: ["数据结构", "算法"] }, { name: "电子电路", points: ["模电", "数电"] }] },
                    { name: "理学", desc: "基础科学与理论研究", courses: [{ name: "高等数学", points: ["微积分", "级数"] }, { name: "大学物理", points: ["量子力学", "相对论"] }, { name: "化学原理", points: ["热力学", "动力学"] }, { name: "生物科学", points: ["分子生物", "遗传"] }] },
                    { name: "医学", desc: "生命健康与临床实践", courses: [{ name: "解剖学", points: ["骨骼", "神经"] }, { name: "生理学", points: ["循环", "呼吸"] }, { name: "病理学", points: ["炎症", "肿瘤"] }, { name: "药理学", points: ["药代动力", "机制"] }] },
                    { name: "经济学", desc: "资源配置与市场分析", courses: [{ name: "微观经济", points: ["供需", "博弈"] }, { name: "宏观经济", points: ["GDP", "通胀"] }, { name: "计量经济", points: ["回归", "预测"] }, { name: "金融学", points: ["定价", "风险"] }] },
                    { name: "法学", desc: "法律制度与公平正义", courses: [{ name: "宪法", points: ["权利", "机构"] }, { name: "民法", points: ["合同", "侵权"] }, { name: "刑法", points: ["犯罪", "刑罚"] }, { name: "诉讼法", points: ["程序", "证据"] }] },
                    { name: "教育学", desc: "教书育人与心理发展", courses: [{ name: "教育原理", points: ["目的", "制度"] }, { name: "心理学", points: ["认知", "情感"] }, { name: "课程论", points: ["设计", "评价"] }, { name: "教学法", points: ["模式", "策略"] }] },
                    { name: "文学", desc: "语言文字与审美文化", courses: [{ name: "文学史", points: ["流派", "作家"] }, { name: "文学理论", points: ["叙事", "批评"] }, { name: "语言学", points: ["语音", "语法"] }, { name: "比较文学", points: ["跨文化", "翻译"] }] },
                    { name: "历史学", desc: "人类过往与文明演进", courses: [{ name: "通史", points: ["朝代", "事件"] }, { name: "考古学", points: ["发掘", "文物"] }, { name: "史学史", points: ["流派", "思想"] }, { name: "专门史", points: ["经济史", "文化史"] }] },
                    { name: "管理学", desc: "组织协调与效率提升", courses: [{ name: "管理原理", points: ["计划", "控制"] }, { name: "会计学", points: ["报表", "核算"] }, { name: "市场营销", points: ["4P", "定位"] }, { name: "人力资源", points: ["招聘", "绩效"] }] },
                    { name: "哲学", desc: "世界观与思维方法", courses: [{ name: "中哲", points: ["儒家", "道家"] }, { name: "西哲", points: ["理性", "经验"] }, { name: "逻辑学", points: ["推理", "谬误"] }, { name: "伦理学", points: ["道德", "价值"] }] },
                    { name: "农学", desc: "农业生产与生态环境", courses: [{ name: "作物学", points: ["育种", "栽培"] }, { name: "植保", points: ["病理", "昆虫"] }, { name: "土壤学", points: ["肥力", "环境"] }, { name: "园艺", points: ["果树", "花卉"] }] },
                    { name: "艺术学", desc: "审美创造与情感表达", courses: [{ name: "艺术概论", points: ["本质", "功能"] }, { name: "美术", points: ["绘画", "雕塑"] }, { name: "设计", points: ["平面", "环境"] }, { name: "音乐", points: ["乐理", "和声"] }] }
                ]
            }
        };
        // ---------------------------
        // DOM & Logic
        // ---------------------------
        const viewHome = document.getElementById('view-home');
        const viewCatalog = document.getElementById('view-catalog');
        const viewChat = document.getElementById('view-chat');
        const btnHome = document.getElementById('btn-home');
        const btnOpenChat = document.getElementById('btn-open-chat');
        const btnBackHomeText = document.getElementById('btn-back-home-text');
        const btnCatalogOpenChat = document.getElementById('btn-catalog-open-chat');
        const btnChatBack = document.getElementById('btn-chat-back');
        const breadcrumb = document.getElementById('breadcrumb');
        const catalogTitle = document.getElementById('catalog-title');
        const catalogSubtitle = document.getElementById('catalog-subtitle');
        const catalogContent = document.getElementById('catalog-content');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const messagesList = document.getElementById('messages-list');
        const chatContainer = document.getElementById('chat-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        let historyStack = [];
        let currentModule = null;
        document.getElementById('year').textContent = new Date().getFullYear();
        // Navigation
        function showView(viewId) {
            viewHome.classList.toggle('hidden', viewId !== 'home');
            viewCatalog.classList.toggle('hidden', viewId !== 'catalog');
            viewChat.classList.toggle('hidden', viewId !== 'chat');
            
            // Top bar buttons
            btnOpenChat.classList.toggle('hidden', viewId === 'chat');
            if (viewId !== 'chat') window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        btnHome.addEventListener('click', () => showView('home'));
        btnBackHomeText.addEventListener('click', () => showView('home'));
        btnOpenChat.addEventListener('click', () => { showView('chat'); setTimeout(() => userInput.focus(), 50); });
        btnCatalogOpenChat.addEventListener('click', () => { showView('chat'); setTimeout(() => userInput.focus(), 50); });
        btnChatBack.addEventListener('click', () => {
             if(currentModule) showView('catalog');
             else showView('home');
        });
        // Module Clicks
        document.querySelectorAll('[data-module]').forEach(btn => {
            btn.addEventListener('click', () => {
                openCatalog(btn.getAttribute('data-module'));
            });
        });
        function openCatalog(moduleKey) {
            currentModule = moduleKey;
            const m = CATALOG[moduleKey];
            if(!m) return;
            // Theme Handling
            const theme = m.theme || 'blue';
            const bgClass = `bg-${theme}-600`;
            const hoverClass = `hover:bg-${theme}-700`;
            
            // Update Header
            catalogTitle.textContent = m.title;
            catalogSubtitle.textContent = m.subtitle;
            
            // Update Catalog Main Button
            btnCatalogOpenChat.className = `inline-flex items-center gap-2 px-5 py-2.5 rounded-xl text-white shadow-md transition-transform active:scale-95 font-medium ${bgClass} ${hoverClass}`;
            // Render Content
            catalogContent.innerHTML = '';
            
            m.sections.forEach(sec => {
                const card = document.createElement('div');
                card.className = `bg-white border border-${theme}-200 rounded-2xl p-5 shadow-sm hover:shadow-md transition-shadow`;
                if(moduleKey !== 'university') {
                    // Primary/Secondary
                    const kws = sec.keywords.map(k => 
                        `<button class="kw px-2.5 py-1 text-xs rounded-md bg-${theme}-50 text-${theme}-700 hover:bg-${theme}-100 transition-colors cursor-pointer" data-val="${k}">${k}</button>`
                    ).join('');
                    
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">${sec.name}</h3>
                                <p class="text-xs text-slate-500 mt-1">${sec.desc}</p>
                            </div>
                            <button class="ask-btn text-xs font-bold px-3 py-1.5 rounded-lg bg-${theme}-100 text-${theme}-700 hover:bg-${theme}-200 transition-colors" data-ask="${m.title}·${sec.name}">提问</button>
                        </div>
                        <div class="flex flex-wrap gap-2">${kws} <button class="kw px-2.5 py-1 text-xs rounded-md bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors cursor-pointer" data-val="等等">等等</button></div>
                    `;
                } else {
                    // University
                    const coursesHtml = sec.courses.map(c => {
                        const pointsHtml = c.points.map(p => `<span class="cursor-pointer hover:text-${theme}-600 hover:underline kw-text" data-val="${p}">${p}</span>`).join(' <span class="text-slate-300">|</span> ');
                        return `
                            <div class="mb-3 last:mb-0">
                                <div class="flex items-center justify-between text-sm mb-1">
                                    <span class="font-bold text-slate-700">${c.name}</span>
                                    <button class="text-[10px] px-2 py-0.5 rounded border border-${theme}-200 text-${theme}-600 hover:bg-${theme}-50 ask-btn" data-ask="${m.title}·${sec.name}·${c.name}">就此提问</button>
                                </div>
                                <div class="text-xs text-slate-500 leading-relaxed">${pointsHtml} <span class="text-slate-300">|</span> <span class="cursor-pointer hover:text-${theme}-600 hover:underline kw-text" data-val="等等">等等</span></div>
                            </div>
                        `;
                    }).join('');
                    card.innerHTML = `
                        <div class="border-b border-${theme}-100 pb-3 mb-3">
                            <h3 class="text-lg font-bold text-${theme}-900">${sec.name}</h3>
                            <p class="text-xs text-${theme}-700/70">${sec.desc}</p>
                        </div>
                        <div>${coursesHtml}</div>
                    `;
                }
                catalogContent.appendChild(card);
            });
            // Bind Events
            catalogContent.querySelectorAll('.kw, .kw-text').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const txt = e.target.getAttribute('data-val');
                    openChatWithPrefill(`${m.title}：${txt}（请讲解概念+典型题/例子+易错点）`);
                });
            });
            catalogContent.querySelectorAll('.ask-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const target = e.target.getAttribute('data-ask');
                    openChatWithPrefill(`${target}：请给一个学习路线 + 关键知识点拆解 + 2道例题/案例`);
                });
            });
            showView('catalog');
        }
        function openChatWithPrefill(text) {
            showView('chat');
            userInput.value = text;
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 150) + 'px';
            setTimeout(() => userInput.focus(), 50);
        }
        // Chat Logic
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        sendBtn.addEventListener('click', sendMessage);
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            if (!API_CONFIG.apiKey) {
                appendMessage('bot', '**请先配置 API Key**\n\n请在代码中的 `API_CONFIG` 区域填入您的 Key。');
                return;
            }
            appendMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto';
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            try {
                const response = await fetchLLM(text);
                loadingIndicator.classList.add('hidden');
                appendMessage('bot', response);
            } catch (err) {
                loadingIndicator.classList.add('hidden');
                appendMessage('bot', `**出错了**：${err.message}`);
            } finally {
                sendBtn.disabled = false;
            }
        }
        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = `flex gap-4 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = role === 'user' 
                ? `<div class="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-user"></i></div>`
                : `<div class="w-10 h-10 rounded-full bg-white border border-slate-200 text-blue-600 flex items-center justify-center flex-shrink-0 shadow-sm"><i class="fa-solid fa-robot"></i></div>`;
            
            const bubbleStyle = role === 'user'
                ? 'bg-slate-800 text-white rounded-tr-none'
                : 'bg-white text-slate-800 border border-slate-100 rounded-tl-none shadow-sm prose prose-slate prose-sm md:prose-base';
            div.innerHTML = `
                ${avatar}
                <div class="p-4 rounded-2xl max-w-[85%] ${bubbleStyle}">
                    ${role === 'bot' ? marked.parse(content) : content.replace(/\n/g, '<br>')}
                </div>
            `;
            messagesList.appendChild(div);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
        async function fetchLLM(prompt) {
            const systemPrompt = `你是"明学智答"全科教学助手智能体。你的知识覆盖小学、初中、高中、大学、研究生。

要求：
1) 先判断用户可能处于哪个阶段（小学/中学/大学/考研/研究生），并以该阶段可理解的方式讲解，若无法判断是哪一阶段，从多阶段角度分别解析问题的不同理解层次，提供从基础到进阶的渐进式解释，明确标注各部分内容适合的阶段。
2) 理科：给出清晰步骤、关键公式/定理、典型例题、易错点与检验方法。
3) 文科：给出框架、关键概念、时间线/因果链、论述模板与例子。
4) 若用户给出"科目/课程/关键词"，优先围绕这些点组织答案。
5）若为复杂问题/跨学科问题：将复杂问题分解为多个子问题，明确各学科在问题中的贡献与视角，提供跨学科理解的整体框架。
6）复杂关系使用表格、列表、流程图等可视化元素。
7）研究型问题：提供学术脉络、关键文献、方法论指导。
8）输出使用Markdown，结构清晰。不要用LaTeX格式渲染公式，直接用文本或Unicode符号，结构清晰：概念→方法→例题/例子→易错点→小结。`;
            
            let endpoint = API_CONFIG.baseUrl.replace(/\/+$/, '');
            if (!endpoint.endsWith('/chat/completions')) endpoint += endpoint.endsWith('/v1') ? '/chat/completions' : '/v1/chat/completions';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_CONFIG.apiKey}` },
                body: JSON.stringify({
                    model: API_CONFIG.model,
                    messages: [{role: 'system', content: systemPrompt}, {role: 'user', content: prompt}],
                    temperature: 0.7
                })
            });
            
            if(!res.ok) throw new Error(`API Error ${res.status}`);
            const data = await res.json();
            return data.choices[0].message.content;
        }
    </script>
</body>
</html>
